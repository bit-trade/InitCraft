# InitCraft v1.0.0-beta
[if you don't understand Russian, here is the English version](README.en.md)

## Описание

***InitCraft*** — это инструмент автоматизации для первичной настройки серверов (VPS или физических хостов), реализованный на Python. Он позволяет системным администраторам быстро подготовить окружение путём:

- генерации или загрузки карты конфигурации,
- автоматического редактирования системных конфигов по шаблону,
- создания резервных копий,
- восстановления из последних бэкапов,
- конвертации текстовых конфигов в JSON,
- а также выбора между CLI и TUI режимами работы.

Благодаря гибкой архитектуре, *InitCraft* можно использовать как в интерактивном режиме (TUI через curses), так и в полностью автоматизированном (CLI с аргументами запуска). Он подходит для рутинной DevOps-автоматизации, стандартизации серверных конфигураций и ускорения развёртывания новых систем.

---

## Возможности

- [x] Загрузка карты конфигурации `env.json` из стандартного каталога
- [x] Генерация новой карты конфигурации с нуля (режим `generate`)
- [x] Загрузка пользовательской карты конфигурации (режим `file`)
- [x] Заполнение карты вручную (режим `inline`)
- [x] Редактирование файлов конфигурации на основе карты (автоматически)
- [x] Создание резервных копий всех указанных файлов конфигурации
- [x] Восстановление конфигураций из последних доступных `.bak` файлов
- [x] Конвертация текстовых конфигураций в JSON-файлы для последующей обработки
- [x] Поддержка CLI-режима: можно использовать в скриптах и при автоматизации
- [x] Поддержка TUI-режима: удобное меню в терминале для интерактивного использования
- [x] Автоматическая перезагрузка после применения настроек (опционально)

---

## Установка

***InitCraft*** не требует сторонних библиотек — он полностью написан с использованием стандартных библиотек Python 3.10.x. Это делает его особенно удобным для использования на «чистых» серверах, где ещё не установлен git, pip и т.п.

### Шаги установки:

1. **Скачайте проект напрямую с GitHub**  
   (если `git` ещё не установлен, используйте `wget`):
   ```bash
   wget https://github.com/bit-trade/InitCraft/archive/refs/heads/main.zip
   unzip main.zip
   cd InitCraft-main
   ```
 
2. **Убедитесь, что установлен Python 3.10+**
   ```bash
   python3 --version
   ```
   Если Python не установлен — выполните установку (пример для Ubuntu/Debian):
   ```bash
   sudo apt update
   sudo apt install python3.10
   ```

3. **Готово - можно сразу запускать**
   ```bash
   python3 initcraft
   ```

### Если вы всё же предпочитаете использовать `git`:

```bash
sudo apt install git
git clone https://github.com/bit-trade/InitCraft.git
cd InitCraft
```

---

## Запуск

> ⚠️ **Внимание:** *InitCraft* требует запуска с правами `root`, так как утилита работает с системными файлами: `hosts`, `hostname`, `sshd_config`, `nftables.conf`, `fstab` и т.д.

Перед запуском убедитесь, что вы внимательно проверили содержимое конфигурационного файла `env.json`, особенно если вы его редактировали вручную. Ошибки в нём могут привести к повреждению конфигурации системы.

### Стандартный запуск (интерактивный режим)

```bash
sudo python3 initcraft
```

При отсутствии аргументов запустится TUI-меню — удобный текстовый интерфейс, где вы сможете выбрать один из вариантов:
- загрузить карту конфигурации
- сгенерировать начальную карту
- указать собственную
- заполнить вручную список системных конфигов

### Запуск с аргументами (CLI-режим)

Если указаны параметры запуска (`--mode`, `--config`, `--apply`, и т.д.), *InitCraft* переключается в CLI-режим:

```bash
sudo python3 initcraft --mode 3 --config /home/admin/file.json --apply --reboot
```

Для просмотра всех доступных флагов используйте аргумент `-h`:

```bash
python3 initcraft -h
```

### Как создать файл `env.json`

Если вы создаёте файл `env.json` вручную, убедитесь, что он корректно отформатирован.
Минимально допустимое содержимое:

```json
{
  "config_files": []
}
```

Ключ `config_files` обязателен, даже если он пока пустой. От него зависит работа многих внутренних функций *InitCraft*.

### Как правильно форматировать значения ключей

Поскольку карта конфигурации работает с текстовыми системными файлами, в значениях JSON могут использоваться управляющие символы:
- \n — перевод строки
- \t — табуляция

Пример корректно конвертированного файла `hosts`:

```json
{
  "/etc/hosts": [
    "# Generated by FORin\n",
    "127.0.0.1\tlocalhost localhost.localdomain\n",
    "::1\tlocalhost ip6-localhost ip6-loopback\n",
    "121.212.123.231\tserver.example.com server\n"
  ]
}
```

> ❗ Не удаляйте `\n` и `\t` — они нужны, чтобы сохранить структуру конфигов при записи.

Рекомендуется пользоваться TUI-режимом или встроенной генерацией начальной карты (`--mode 2`) для минимизации ошибок.

---

## Примеры

Ниже представлены типовые примеры запуска *InitCraft* в **CLI-режиме** — когда утилита управляется через аргументы командной строки.

> ⚠️ Все команды должны запускаться с правами `root`, так как работа происходит с системными файлами.

### Сгенерировать начальную карту конфигурации JSON формата

```bash
sudo python3 initcraft --mode 2
```

Что происходит:
- будет создан файл `env.json` в корне проекта (если его нет);
- в файл добавляется ключ `config_files` со значением `[]` (пустой список);
- этот режим используется для создания "чистой заготовки" карты конфигурации, которую можно позже заполнить вручную или в интерактивном режиме.

### Заполнить карту конфигурации данными из конфиг-файлов (режим inline)

```bash
sudo python3 initcraft -m 4 --config "/etc/hosts /etc/hostname /etc/ssh/sshd_config"
```

Что происходит:
- переданные пути к системным конфигам будут сохранены в ключ `config_files` внутри `env.json`;
- если файла `env.json` нет — он будет создан;
- утилита не изменяет сами конфиг-файлы, только формирует карту конфигурации на их основе.

### Создать резервные копии конфигурационных файлов

```bash
sudo python3 initcraft -b --config "/etc/hosts /etc/hostname /etc/ssh/sshd_config"
```

Что происходит:
- будут созданы резервные копии указанных файлов;
- бэкапы сохраняются во вложенной директории `backup/`, с именами по шаблону `<имя_файла>.<timestamp>.bak`.
- лог операции сохраняется и выводится в консоль.

### Конвертировать текстовые конфигурационные файлы в JSON

```bash
sudo python3 initcraft --convert true --config /etc/hostname,/etc/fstab,/etc/nftables.conf
```

Что происходит:
- каждый указанный файл читается построчно;
- для каждого создаётся `.json`-файл, содержащий список строк в виде массива;
- все JSON-файлы сохраняются в директории `converted/`.

> 🛈 Полезно, если вы хотите изучить или сравнить содержимое системных конфигов через JSON.

### Применить изменения и перезагрузить систему

```bash
sudo python3 initcraft -m 1 --apply --reboot
```

Что происходит:
- загружается существующий файл `env.json` с ключом `config_files`;
- для каждого файла выполняются замены/редактирование (в зависимости от содержимого карты);
- создаются резервные копии перед изменением;
- по завершении — утилита перезапускает систему (если указан флаг `--reboot`).

> ⚠️ Рекомендуется убедиться в корректности содержимого `env.json` перед запуском этой команды.

### Применить настройки из собственной карты конфигурации

```bash
sudo python3 initcraft -m 3 -a --config /home/admin/file_name.json
```

Что происходит:
- загрузка пользовательского файла `file_name.json` по указанному пути;
- применение всех настроек и редактирование файлов, указанных в `config_files`;
- все действия логируются и сопровождаются резервным копированием.

### Восстановить конфиг-файлы из последних бэкапов

```bash
sudo python3 initcraft --rollback --config "/etc/fstab, /etc/nftables.conf, /etc/ssh/sshd_config"
```

Что происходит:
- утилита ищет наиболее свежие `.bak`-файлы в каталоге `backup/` и его подкаталогах;
- восстанавливает указанные файлы путём копирования последнего бэкапа на оригинальное место;
- в случае ошибок — отображается предупреждение, но выполнение продолжается для остальных файлов.

> 🛠 Полезно для отката изменений после неудачного применения карты конфигурации.

---

## Структура проекта

Ниже представлена структура проекта `InitCraft`, с пояснением ключевых файлов и директорий:

```
InitCraft/
├── app.py
├── initcraft
├── constant.py
├── env.json
├── utils/
│ ├── backup.py
│ ├── cli_mode.py
│ ├── converter.py
│ ├── editor.py
│ ├── menu_print.py
│ ├── os_worker.py
│ └── tui_mode.py
├── backup/
├── converted/
├── InitCraft.log
├── README.md
├── README.en.md
└── README.ru.md
```

### 🔧 Корневые файлы

- **`app.py`**  
  Главная точка входа в утилиту. Выполняет проверку запуска от `root`, инициирует TUI или CLI-режим в зависимости от аргументов.  
  Фактически — оболочка и диспетчер логики.

- **`initcraft`**  
  Символическая ссылка, позволяющая запускать `InitCraft` как утилиту без `.py`.  
  Может быть подключена в `$PATH` для системного вызова.

- **`env.json`**  
  Основной файл карты конфигурации. Хранит список файлов для редактирования, а также новое содержимое, которое должно быть применено.  
  Имеет строгую структуру и используется в режимах `default`, `file`, `inline`.

- **`constant.py`**  
  Содержит глобальные переменные: имя утилиты, номер версии, логгеры, цветовые схемы TUI, сообщения и текстовые шаблоны меню.  
  Позволяет централизованно управлять общими настройками.

- **`InitCraft.log`**  
  Лог-файл, в который пишутся все действия утилиты: создание/применение/восстановление файлов, ошибки, предупреждения и отладочные сообщения.

### 📁 Директории

- **`backup/`**  
  Каталог для хранения резервных копий файлов.  
  Имена файлов формируются по шаблону: `<имя_файла>.<timestamp>.bak`.  
  Поддерживает вложенные папки, если файлы из разных мест.

- **`converted/`**  
  Каталог, в который сохраняются конвертированные JSON-файлы на основе содержимого оригинальных текстовых конфигураций (например, `/etc/hosts`).  
  Используется функцией `txt_to_json()`.

### 🧩 Модуль `utils/`

- **`backup.py`**  
  Содержит функции создания и восстановления резервных копий конфигурационных файлов.  
  Применяется как вручную через CLI, так и автоматически перед применением настроек.

- **`cli_mode.py`**  
  Обрабатывает аргументы командной строки (через `argparse`).  
  Определяет режим запуска (`--mode`), путь к конфигу, флаги `--apply`, `--convert`, `--reboot`, `--rollback` и др.

- **`converter.py`**  
  Содержит функцию `txt_to_json()` с построчной обработкой данных, конвертирующую системные текстовые конфигурации в структурированный JSON.  
  Позволяет создавать карты конфигурации из существующих файлов.

- **`editor.py`**  
  Ключевой модуль, содержащий класс `ConfigMaker`.  
  Реализует логику загрузки, редактирования, применения конфигураций, валидации карты и интеграцию с другими модулями.  
  Управляет режимами: `default`, `generate`, `file`, `inline`.

- **`menu_print.py`**  
  Вспомогательный модуль, который реализует взаимодействие с пользователем/разработчиком в консоли IDE.

- **`os_worker.py`**  
  Содержит классы и функции для взаимодействия с операционной системой, включая перезагрузку (`reboot`) и выполнение системных команд.  
  Работает только с `root`-правами.

- **`tui_mode.py`**  
  Реализует TUI-интерфейс с использованием библиотеки `curses`.  
  Позволяет пользователю выполнять все действия интерактивно — выбирать режимы, загружать и применять карты конфигурации.

### 🗂 Прочие файлы

- **`README.md`**  
  Основная документация проекта, на русском языке.

- **`README.en.md`**  
  Альтернативная языковая версия описания проекта.

---

## Требования

`InitCraft` разработан с прицелом на простоту и полную автономность. Утилита не требует сторонних библиотек или фреймворков — используется только стандартные библиотеки Python.

### Минимальные требования:

- **Python** версии **3.10** (или совместимой)
- **Root-доступ** к целевому серверу (VPS/ServerPC)
- **Доступ к терминалу**:
  - через **SSH** (удалённое подключение)
  - или через **физическую консоль** (монитор, клавиатура, USB-доступ и т.д.)

### Установка дополнительных зависимостей — не требуется.

Утилита готова к работе сразу после копирования на сервер, даже если `git` ещё не установлен.

---

## Автор

**Igor Mironenko** — системный инженер, Python-разработчик для DevOps и автоматизации серверов.

GitHub: [bit-trade](https://github.com/bit-trade)  
Telegram: [@F0Rin](https://t.me/F0Rin)

---
